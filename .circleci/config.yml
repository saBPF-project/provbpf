# Use the latest 2.1 version of CircleCI pipeline process engine. See: https://circleci.com/docs/2.0/configuration-reference
version: 2.1
jobs:
  build:
    docker:
      - image: fedora:33
    resource_class: medium
    working_directory: ~/build
    steps:
      - checkout
      - run: 'sudo dnf -y -v groupinstall "Development Tools"'
      - run: 'sudo dnf install -y cmake clang gcc-c++ wget git pesign grubby'
      - run: 'sudo dnf install -y openssl-devel bc nano patch mosquitto sparse'
      - run: 'sudo dnf install -y llvm bpftool libbpf libbpf-devel'
      - run: 'sudo dnf install -y elfutils-libelf libcap binutils-devel'
      - run: 'sudo dnf install -y ruby uthash-devel inih-devel'
      - run: 'sudo dnf install -y rpm-build redhat-rpm-config elfutils-devel'
      - run: 'sudo dnf install -y bison flex dwarves libcap openssl'
      - run: 'cd ~/build && git clone https://${GH_TOKEN}@github.com/tfjmp/provbpf-kernel.git'
      - run: 'cd ~/build/provbpf-kernel && make prepare'
      - run: 'cd ~/build/provbpf-kernel && make save_space'
      - run: 'cd ~/build/provbpf-kernel && make config_circle'
      - run: 'cd ~/build/provbpf-kernel && make build_kernel'
      - run: 'cd ~/build/provbpf-kernel && make install_header'
      - run: 'cd ~/build/provbpf-kernel && make install_kernel'
      - run: 'cd ~/build/provbpf-kernel && make build_bpf'
      - run: 'cd ~/build/provbpf-kernel && make install_bpf'
      - run: 'make prepare_build'
      - run: 'make clean'
      - run: 'make btf_circle'
      - run: 'make kern'
      - run: 'make skel'
      - run: 'make usr'
      - run: 'make rpm'
workflows:
  build_and_deploy:
    jobs:
      - build
